/**
 * Mob Editor Component
 */
class MobEditor {
    constructor(editor) {
        this.editor = editor;
        this.currentMob = null;
        this.fieldManager = new EntityFieldManager();
    }
    
    render(mob) {
        this.currentMob = mob;
        const container = document.getElementById('mob-editor-view');
        if (!container) return;
        
        const isAdvanced = this.editor.state.currentMode === 'advanced';
        
        container.innerHTML = `
            <div class="editor-container">
                <h2 class="section-title">
                    <i class="fas fa-skull"></i>
                    Edit Mob: ${mob.name}
                </h2>
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-id-card"></i> Core Identity</h3>
                    </div>
                    <div class="card-body">
                        <div class="grid-2">
                            <div class="form-group">
                                <label class="form-label">Internal Name <span class="required">*</span></label>
                                <input type="text" class="form-input" id="mob-name" value="${mob.name}">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Entity Type <span class="required">*</span></label>
                                <select class="form-select" id="mob-type">
                                    ${this.renderEntityTypes(mob.type)}
                                </select>
                            </div>
                        </div>
                        <div class="form-group" data-mob-field="Display">
                            <label class="form-label">Display Name</label>
                            <input type="text" class="form-input" id="mob-display" value="${mob.display || ''}">
                            <small class="form-hint">Use & for color codes (e.g., &6Gold Text)</small>
                        </div>
                        <div class="grid-3">
                            <div class="form-group" data-mob-field="Glowing">
                                <label class="form-label">
                                    <input type="checkbox" id="mob-glowing" ${mob.glowing ? 'checked' : ''}>
                                    Glowing
                                </label>
                            </div>
                            <div class="form-group" data-mob-field="Invisible">
                                <label class="form-label">
                                    <input type="checkbox" id="mob-invisible" ${mob.invisible ? 'checked' : ''}>
                                    Invisible
                                </label>
                            </div>
                            <div class="form-group" data-mob-field="Silent">
                                <label class="form-label">
                                    <input type="checkbox" id="mob-silent" ${mob.silent ? 'checked' : ''}>
                                    Silent
                                </label>
                            </div>
                        </div>
                        <div class="grid-2">
                            <div class="form-group" data-mob-field="NoGravity">
                                <label class="form-label">
                                    <input type="checkbox" id="mob-nogravity" ${mob.noGravity ? 'checked' : ''}>
                                    No Gravity
                                </label>
                            </div>
                            <div class="form-group" data-mob-field="Persistent">
                                <label class="form-label">
                                    <input type="checkbox" id="mob-persistent" ${mob.persistent ? 'checked' : ''}>
                                    Persistent (No Despawn)
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-heart"></i> Combat Stats</h3>
                    </div>
                    <div class="card-body">
                        <div class="grid-3">
                            <div class="form-group" data-mob-field="Health">
                                <label class="form-label">Health</label>
                                <input type="number" class="form-input" id="mob-health" value="${mob.health || 20}" min="1">
                                <small class="form-hint">${this.fieldManager.getFieldHint('Health')}</small>
                            </div>
                            <div class="form-group" data-mob-field="Damage">
                                <label class="form-label">Damage</label>
                                <input type="number" class="form-input" id="mob-damage" value="${mob.damage || 0}" min="0">
                                <small class="form-hint">${this.fieldManager.getFieldHint('Damage')}</small>
                            </div>
                            <div class="form-group" data-mob-field="Armor">
                                <label class="form-label">Armor</label>
                                <input type="number" class="form-input" id="mob-armor" value="${mob.armor || 0}" min="0">
                                <small class="form-hint">${this.fieldManager.getFieldHint('Armor')}</small>
                            </div>
                        </div>
                        <div class="grid-3">
                            <div class="form-group" data-mob-field="MovementSpeed">
                                <label class="form-label">Movement Speed</label>
                                <input type="number" class="form-input" id="mob-speed" value="${mob.movementSpeed || 0.25}" step="0.01">
                                <small class="form-hint">${this.fieldManager.getFieldHint('MovementSpeed')}</small>
                            </div>
                            <div class="form-group" data-mob-field="FollowRange">
                                <label class="form-label">Follow Range</label>
                                <input type="number" class="form-input" id="mob-range" value="${mob.followRange || 32}" min="0">
                                <small class="form-hint">${this.fieldManager.getFieldHint('FollowRange')}</small>
                            </div>
                            <div class="form-group" data-mob-field="KnockbackResistance">
                                <label class="form-label">Knockback Resistance</label>
                                <input type="number" class="form-input" id="mob-knockback" value="${mob.knockbackResistance || 0}" min="0" max="1" step="0.1">
                                <small class="form-hint">${this.fieldManager.getFieldHint('KnockbackResistance')}</small>
                            </div>
                        </div>
                        <div class="form-group" data-mob-field="AttackSpeed">
                            <label class="form-label">Attack Speed</label>
                            <input type="number" class="form-input" id="mob-attackspeed" value="${mob.attackSpeed || 20}" min="1">
                            <small class="form-hint">${this.fieldManager.getFieldHint('AttackSpeed')}</small>
                        </div>
                    </div>
                </div>
                
                <div class="card" data-mob-field="Size">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-expand"></i> Size</h3>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Size</label>
                            <input type="number" class="form-input" id="mob-size" value="${mob.size || 1}" min="1" max="127">
                            <small class="form-hint">${this.fieldManager.getFieldHint('Size')}</small>
                        </div>
                    </div>
                </div>
                
                <div class="card" data-mob-field="Pose">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-running"></i> Armor Stand Options</h3>
                    </div>
                    <div class="card-body">
                        <div class="grid-2">
                            <div class="form-group" data-mob-field="Small">
                                <label class="form-label">
                                    <input type="checkbox" id="mob-small" ${mob.small ? 'checked' : ''}>
                                    Small
                                </label>
                            </div>
                            <div class="form-group" data-mob-field="ShowArms">
                                <label class="form-label">
                                    <input type="checkbox" id="mob-showarms" ${mob.showArms ? 'checked' : ''}>
                                    Show Arms
                                </label>
                            </div>
                            <div class="form-group" data-mob-field="ShowBasePlate">
                                <label class="form-label">
                                    <input type="checkbox" id="mob-showbaseplate" ${mob.showBasePlate ? 'checked' : ''}>
                                    Show Base Plate
                                </label>
                            </div>
                            <div class="form-group" data-mob-field="Marker">
                                <label class="form-label">
                                    <input type="checkbox" id="mob-marker" ${mob.marker ? 'checked' : ''}>
                                    Marker (No Hitbox)
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card" data-mob-field="Age">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-baby"></i> Age Options</h3>
                    </div>
                    <div class="card-body">
                        <div class="grid-2">
                            <div class="form-group" data-mob-field="Age">
                                <label class="form-label">Age</label>
                                <input type="number" class="form-input" id="mob-age" value="${mob.age || 0}">
                                <small class="form-hint">-24000 for baby, 0 for adult</small>
                            </div>
                            <div class="form-group" data-mob-field="Baby">
                                <label class="form-label">
                                    <input type="checkbox" id="mob-baby" ${mob.baby ? 'checked' : ''}>
                                    Baby
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card" data-mob-field="ExplosionRadius">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-bomb"></i> Creeper Options</h3>
                    </div>
                    <div class="card-body">
                        <div class="grid-2">
                            <div class="form-group" data-mob-field="ExplosionRadius">
                                <label class="form-label">Explosion Radius</label>
                                <input type="number" class="form-input" id="mob-explosionradius" value="${mob.explosionRadius || 3}" min="0">
                                <small class="form-hint">${this.fieldManager.getFieldHint('ExplosionRadius')}</small>
                            </div>
                            <div class="form-group" data-mob-field="FuseTime">
                                <label class="form-label">Fuse Time</label>
                                <input type="number" class="form-input" id="mob-fusetime" value="${mob.fuseTime || 30}" min="1">
                                <small class="form-hint">${this.fieldManager.getFieldHint('FuseTime')}</small>
                            </div>
                        </div>
                        <div class="form-group" data-mob-field="Powered">
                            <label class="form-label">
                                <input type="checkbox" id="mob-powered" ${mob.powered ? 'checked' : ''}>
                                Charged
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="card" data-mob-field="Profession">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-briefcase"></i> Villager Options</h3>
                    </div>
                    <div class="card-body">
                        <div class="grid-2">
                            <div class="form-group" data-mob-field="Profession">
                                <label class="form-label">Profession</label>
                                <select class="form-select" id="mob-profession">
                                    <option value="NONE">None</option>
                                    <option value="ARMORER">Armorer</option>
                                    <option value="BUTCHER">Butcher</option>
                                    <option value="CARTOGRAPHER">Cartographer</option>
                                    <option value="CLERIC">Cleric</option>
                                    <option value="FARMER">Farmer</option>
                                    <option value="FISHERMAN">Fisherman</option>
                                    <option value="FLETCHER">Fletcher</option>
                                    <option value="LEATHERWORKER">Leatherworker</option>
                                    <option value="LIBRARIAN">Librarian</option>
                                    <option value="MASON">Mason</option>
                                    <option value="NITWIT">Nitwit</option>
                                    <option value="SHEPHERD">Shepherd</option>
                                    <option value="TOOLSMITH">Toolsmith</option>
                                    <option value="WEAPONSMITH">Weaponsmith</option>
                                </select>
                            </div>
                            <div class="form-group" data-mob-field="VillagerLevel">
                                <label class="form-label">Villager Level</label>
                                <input type="number" class="form-input" id="mob-villagerlevel" value="${mob.villagerLevel || 1}" min="1" max="5">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card" data-mob-field="Equipment">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-shield-alt"></i> Equipment</h3>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Equipment Items</label>
                            <small class="form-hint">Format: SLOT:ITEM:DROPCHANCE (e.g., HEAD:DIAMOND_HELMET:0.1)</small>
                            <textarea class="form-input" id="mob-equipment" rows="4">${mob.equipment || ''}</textarea>
                        </div>
                    </div>
                </div>
                
                <div class="card" data-mob-field="AIGoalSelectors">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-brain"></i> AI Options</h3>
                    </div>
                    <div class="card-body">
                        <div class="grid-2">
                            <div class="form-group" data-mob-field="PreventOtherDrops">
                                <label class="form-label">
                                    <input type="checkbox" id="mob-preventotherdrops" ${mob.preventOtherDrops ? 'checked' : ''}>
                                    Prevent Other Drops
                                </label>
                            </div>
                            <div class="form-group" data-mob-field="PreventRandomEquipment">
                                <label class="form-label">
                                    <input type="checkbox" id="mob-preventrandomequipment" ${mob.preventRandomEquipment ? 'checked' : ''}>
                                    Prevent Random Equipment
                                </label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Custom AI Goals</label>
                            <small class="form-hint">Advanced: Custom AI goal selectors</small>
                            <textarea class="form-input" id="mob-aigoals" rows="3">${mob.aiGoals || ''}</textarea>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-magic"></i> Skills</h3>
                    </div>
                    <div class="card-body">
                        <div id="mob-skills-list" class="skill-list">
                            ${this.renderSkills(mob.skills)}
                        </div>
                        <button class="add-item-btn" id="add-skill-btn">
                            <i class="fas fa-plus"></i> Add Skill
                        </button>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-box"></i> Drops</h3>
                    </div>
                    <div class="card-body">
                        <div id="mob-drops-list" class="drop-list">
                            ${this.renderDrops(mob.drops)}
                        </div>
                        <button class="add-item-btn" id="add-drop-btn">
                            <i class="fas fa-plus"></i> Add Drop
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        this.attachEventListeners();
    }
    
    renderEntityTypes(selected) {
        const categories = this.fieldManager.getEntitiesByCategory();
        let html = '';
        
        Object.entries(categories).forEach(([category, entities]) => {
            html += `<optgroup label="${category}">`;
            entities.forEach(entity => {
                html += `<option value="${entity}" ${entity === selected ? 'selected' : ''}>${entity}</option>`;
            });
            html += `</optgroup>`;
        });
        
        return html;
    }
    
    renderSkills(skills) {
        if (!skills || skills.length === 0) {
            return '<div class="empty-state"><p>No skills yet</p></div>';
        }
        
        return skills.map(skill => `
            <div class="skill-item">
                <i class="fas fa-grip-vertical skill-handle"></i>
                <div class="skill-info">
                    <div class="skill-name">${skill.name}</div>
                    <div class="skill-trigger">${skill.trigger || '~onAttack'}</div>
                </div>
                <div class="skill-actions">
                    <button class="icon-btn" onclick="removeSkill('${skill.id}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `).join('');
    }
    
    renderDrops(drops) {
        if (!drops || drops.length === 0) {
            return '<div class="empty-state"><p>No drops configured</p></div>';
        }
        
        return drops.map(drop => `
            <div class="drop-item">
                <div class="drop-icon"><i class="fas fa-cube"></i></div>
                <div class="drop-info">
                    <span>${drop.item}</span>
                    <span>Amount: ${drop.amount}</span>
                    <span>Chance: ${drop.chance * 100}%</span>
                </div>
                <button class="icon-btn" onclick="removeDrop('${drop.id}')">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `).join('');
    }
    
    attachEventListeners() {
        // Entity type change handler - special handling
        const typeSelect = document.getElementById('mob-type');
        if (typeSelect) {
            typeSelect.addEventListener('change', (e) => {
                this.updateMob('type', e.target.value);
                this.fieldManager.updateFieldVisibility(e.target.value);
                this.fieldManager.applyDefaults(e.target.value);
            });
            
            // Apply initial field visibility
            this.fieldManager.updateFieldVisibility(typeSelect.value);
        }
        
        // Text/number input handlers
        const textInputs = ['name', 'display', 'health', 'damage', 'armor', 'speed', 'range', 
                           'knockback', 'attackspeed', 'size', 'age', 'explosionradius', 'fusetime',
                           'profession', 'villagerlevel', 'equipment', 'aigoals'];
        textInputs.forEach(field => {
            const element = document.getElementById(`mob-${field}`);
            if (element) {
                element.addEventListener('input', () => this.updateMob(field, element.value));
            }
        });
        
        // Checkbox handlers
        const checkboxes = ['glowing', 'invisible', 'silent', 'nogravity', 'persistent',
                           'small', 'showarms', 'showbaseplate', 'marker', 'baby', 'powered',
                           'preventotherdrops', 'preventrandomequipment'];
        checkboxes.forEach(field => {
            const element = document.getElementById(`mob-${field}`);
            if (element) {
                element.addEventListener('change', () => this.updateMob(field, element.checked));
            }
        });
        
        // Add skill button
        document.getElementById('add-skill-btn')?.addEventListener('click', () => this.addSkill());
        
        // Add drop button
        document.getElementById('add-drop-btn')?.addEventListener('click', () => this.addDrop());
    }
    
    updateMob(field, value) {
        if (!this.currentMob) return;
        
        // Map field names to mob properties
        const fieldMap = {
            'name': 'name',
            'type': 'type',
            'display': 'display',
            'health': 'health',
            'damage': 'damage',
            'armor': 'armor',
            'speed': 'movementSpeed',
            'range': 'followRange',
            'knockback': 'knockbackResistance',
            'attackspeed': 'attackSpeed',
            'size': 'size',
            'age': 'age',
            'explosionradius': 'explosionRadius',
            'fusetime': 'fuseTime',
            'profession': 'profession',
            'villagerlevel': 'villagerLevel',
            'glowing': 'glowing',
            'invisible': 'invisible',
            'silent': 'silent',
            'nogravity': 'noGravity',
            'persistent': 'persistent',
            'small': 'small',
            'showarms': 'showArms',
            'showbaseplate': 'showBasePlate',
            'marker': 'marker',
            'baby': 'baby',
            'powered': 'powered',
            'equipment': 'equipment',
            'aigoals': 'aiGoals',
            'preventotherdrops': 'preventOtherDrops',
            'preventrandomequipment': 'preventRandomEquipment'
        };
        
        const prop = fieldMap[field];
        if (prop) {
            // Convert to number for numeric fields
            const numericFields = ['health', 'damage', 'armor', 'speed', 'range', 'knockback', 
                                  'attackspeed', 'size', 'age', 'explosionradius', 'fusetime', 'villagerlevel'];
            
            if (numericFields.includes(field)) {
                this.currentMob[prop] = parseFloat(value) || 0;
            } else if (typeof value === 'boolean') {
                this.currentMob[prop] = value;
            } else {
                this.currentMob[prop] = value;
            }
            
            this.editor.markDirty();
        }
    }
    
    addSkill() {
        this.editor.showToast('Skill adding feature coming soon!', 'info');
    }
    
    addDrop() {
        this.editor.showToast('Drop adding feature coming soon!', 'info');
    }
}

window.MobEditor = MobEditor;
